# Taskfile.yml - Modern task runner (alternative to Makefile)
# Install: brew install go-task/tap/go-task
# Usage: task start, task stop, task health

version: "3"

vars:
  AUTH_PORT: 8001
  ANALYTICS_PORT: 8002
  WORKSPACE_PORT: 8004
  GATEWAY_PORT: 8000

tasks:
  install:
    desc: Install dependencies for all services
    cmds:
      - echo "ðŸ“¦ Installing dependencies..."
      - cd auth-service && python3 -m venv venv && source venv/bin/activate && pip install -r requirements.txt
      - cd analytics-service && python3 -m venv venv && source venv/bin/activate && pip install -r requirements.txt
      - cd workspace-service && python3 -m venv venv && source venv/bin/activate && pip install -r requirements.txt
      - cd api-gateway && python3 -m venv venv && source venv/bin/activate && pip install -r requirements.txt
      - echo "âœ… Dependencies installed"

  start:
    desc: Start all OpenBioCure services
    deps: [stop] # Stop any existing services first
    cmds:
      - echo "ðŸš€ Starting all services..."
      - task: start-auth
      - task: start-analytics
      - task: start-workspace
      - task: start-gateway
      - echo "âœ… All services started"
      - task: health

  start-auth:
    desc: Start auth service
    cmds:
      - cd auth-service && source venv/bin/activate && python3 -m uvicorn main:app --host 0.0.0.0 --port {{.AUTH_PORT}} --reload &

  start-analytics:
    desc: Start analytics service
    cmds:
      - cd analytics-service && source venv/bin/activate && python3 -m uvicorn main:app --host 0.0.0.0 --port {{.ANALYTICS_PORT}} --reload &

  start-workspace:
    desc: Start workspace service
    cmds:
      - cd workspace-service && source venv/bin/activate && python3 -m uvicorn main:app --host 0.0.0.0 --port {{.WORKSPACE_PORT}} --reload &

  start-gateway:
    desc: Start API gateway
    cmds:
      - cd api-gateway && source venv/bin/activate && python3 -m uvicorn main:app --host 0.0.0.0 --port {{.GATEWAY_PORT}} --reload &

  stop:
    desc: Stop all services
    cmds:
      - echo "ðŸ›‘ Stopping services..."
      - pkill -f "uvicorn.*{{.AUTH_PORT}}" || true
      - pkill -f "uvicorn.*{{.ANALYTICS_PORT}}" || true
      - pkill -f "uvicorn.*{{.WORKSPACE_PORT}}" || true
      - pkill -f "uvicorn.*{{.GATEWAY_PORT}}" || true
      - echo "âœ… Services stopped"

  health:
    desc: Check service health
    cmds:
      - echo "ðŸ” Health checks:"
      - curl -s http://localhost:{{.AUTH_PORT}}/health | jq .status || echo "âŒ Auth down"
      - curl -s http://localhost:{{.ANALYTICS_PORT}}/health | jq .status || echo "âŒ Analytics down"
      - curl -s http://localhost:{{.WORKSPACE_PORT}}/health | jq .status || echo "âŒ Workspace down"
      - curl -s http://localhost:{{.GATEWAY_PORT}}/health | jq .status || echo "âŒ Gateway down"

  test:
    desc: Run tests
    cmds:
      - echo "ðŸ§ª Running tests..."
      - python3 -m pytest tests/ -v

  logs:
    desc: Show service logs
    cmds:
      - echo "ðŸ“‹ Live logs (Ctrl+C to exit):"
      - tail -f auth-service/logs/*.log analytics-service/logs/*.log api-gateway/logs/*.log 2>/dev/null || echo "No log files found"

  clean:
    desc: Clean up environments
    cmds:
      - echo "ðŸ§¹ Cleaning..."
      - rm -rf */venv */logs */__pycache__ */*.pyc workspace-service.log
      - echo "âœ… Cleanup complete"

  dev:
    desc: Full development setup
    cmds:
      - task: install
      - task: start
