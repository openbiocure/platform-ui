# OpenBioCure Backend Makefile
# Simple commands to replace all bash scripts

.PHONY: install start stop test health logs clean

# Install dependencies for all services
install:
	@echo "ğŸ“¦ Installing dependencies for all services..."
	cd auth-service && python3 -m venv venv && source venv/bin/activate && pip install -r requirements.txt
	cd analytics-service && python3 -m venv venv && source venv/bin/activate && pip install -r requirements.txt
	cd workspace-service && python3 -m venv venv && source venv/bin/activate && pip install -r requirements.txt
	cd api-gateway && python3 -m venv venv && source venv/bin/activate && pip install -r requirements.txt
	@echo "âœ… All dependencies installed"

# Start all services using honcho
start:
	@echo "ğŸš€ Starting all OpenBioCure services..."
	~/Library/Python/3.9/bin/honcho start

# Alternative: Start services individually
start-dev:
	@echo "ğŸš€ Starting services in development mode..."
	cd auth-service && source venv/bin/activate && python3 -m uvicorn main:app --host 0.0.0.0 --port 8001 --reload &
	cd analytics-service && source venv/bin/activate && python3 -m uvicorn main:app --host 0.0.0.0 --port 8002 --reload &
	cd workspace-service && source venv/bin/activate && python3 -m uvicorn main:app --host 0.0.0.0 --port 8004 --reload &
	cd api-gateway && source venv/bin/activate && python3 -m uvicorn main:app --host 0.0.0.0 --port 8000 --reload &
	@echo "âœ… All services started in background"

# Stop all services
stop:
	@echo "ğŸ›‘ Stopping all services..."
	@pkill -f "uvicorn.*8001" || true
	@pkill -f "uvicorn.*8002" || true
	@pkill -f "uvicorn.*8004" || true
	@pkill -f "uvicorn.*8000" || true
	@pkill -f "honcho" || true
	@echo "âœ… All services stopped"

# Run health checks
health:
	@echo "ğŸ” Checking service health..."
	@curl -s http://localhost:8001/health | jq . || echo "âŒ Auth service down"
	@curl -s http://localhost:8002/health | jq . || echo "âŒ Analytics service down"
	@curl -s http://localhost:8004/health | jq . || echo "âŒ Workspace service down"
	@curl -s http://localhost:8000/health | jq . || echo "âŒ Gateway service down"

# Run tests
test:
	@echo "ğŸ§ª Running tests..."
	@python3 -m pytest tests/ || echo "âš ï¸ No tests found"

# View logs (requires running services)
logs:
	@echo "ğŸ“‹ Service logs:"
	@echo "Auth: tail -f auth-service/logs/app.log"
	@echo "Analytics: tail -f analytics-service/logs/app.log"
	@echo "Workspace: tail -f workspace-service/logs/app.log"
	@echo "Gateway: tail -f api-gateway/logs/app.log"

# Database seeding commands
seed-dev:
	@echo "ğŸŒ± Seeding development database..."
	cd auth-service && APP_ENV=development python3 seed_database.py
	@echo "âœ… Development seeding complete"

seed-staging:
	@echo "ğŸŒ± Seeding staging database..."
	cd auth-service && APP_ENV=staging python3 seed_database.py
	@echo "âœ… Staging seeding complete"

seed-prod:
	@echo "ğŸŒ± Seeding production database..."
	@echo "âš ï¸  Production seeding requires PROD_ADMIN_PASSWORD environment variable"
	cd auth-service && APP_ENV=production python3 seed_database.py
	@echo "âœ… Production seeding complete"

seed-test:
	@echo "ğŸŒ± Seeding test database..."
	cd auth-service && APP_ENV=test python3 seed_database.py
	@echo "âœ… Test seeding complete"

seed-force:
	@echo "ğŸ”„ Force seeding (overwrites existing data)..."
	cd auth-service && python3 seed_database.py --force
	@echo "âœ… Force seeding complete"

seed-dry-run:
	@echo "ğŸ” Dry run seeding (shows what would be created)..."
	cd auth-service && python3 seed_database.py --dry-run
	@echo "âœ… Dry run complete"

# Simple seeding via API (no database dependencies)
seed-simple:
	@echo "ğŸŒ± Simple seeding via API..."
	cd auth-service && python3 seed_simple.py
	@echo "âœ… Simple seeding complete"

# Database management
reset-db:
	@echo "ğŸ—„ï¸ Resetting database..."
	$(MAKE) stop
	@echo "ğŸ§¹ Cleaning up database..."
	@echo "ğŸŒ± Reseeding with development data..."
	$(MAKE) seed-dev
	@echo "âœ… Database reset complete"

# Clean up virtual environments and logs
clean:
	@echo "ğŸ§¹ Cleaning up..."
	rm -rf auth-service/venv analytics-service/venv workspace-service/venv api-gateway/venv
	rm -rf auth-service/logs analytics-service/logs workspace-service/logs api-gateway/logs
	rm -rf **/__pycache__ **/*.pyc
	@echo "âœ… Cleanup complete"

# Setup development environment
setup:
	@echo "ğŸ› ï¸ Setting up development environment..."
	python3 -m pip install honcho supervisor httpx pytest
	$(MAKE) install
	@echo "âœ… Development environment ready"

# Quick start (setup + start)
dev:
	$(MAKE) setup
	$(MAKE) start
